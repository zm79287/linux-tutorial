# Dockerfile

<!-- TOC depthFrom:2 depthTo:3 -->

- [Dockerfile ???](#dockerfile-???)
    - [FROM(???????????)](#from???????????)
    - [RUN(???????)](#run???????)
    - [COPY(???????)](#copy???????)
    - [ADD(?????????????)](#add?????????????)
    - [CMD(????????????)](#cmd????????????)
    - [ENTRYPOINT(????)](#entrypoint????)
    - [ENV(???????????)](#env???????????)
    - [ARG(????????)](#arg????????)
    - [VOLUME(??????????)](#volume??????????)
    - [EXPOSE(??????)](#expose??????)
    - [WORKDIR(?????????)](#workdir?????????)
    - [USER(?????????)](#user?????????)
    - [HEALTHCHECK(???????)](#healthcheck???????)
    - [ONBUILD(?????????????)](#onbuild?????????????)
- [???®≤?????](#???®≤?????)

<!-- /TOC -->

## Dockerfile ???

### FROM(???????????)

> ?????
>
> `FROM` ??????????????????

??¶Õ??????????????????????????????????????ßÿ??????????????????????? `nginx` ????????????????????????????????????????????? `FROM` ???????**????????**???????? `Dockerfile` ?? `FROM` ????????????????????????˛ü

?? [Docker Store](https://store.docker.com/) ???ßŸ???????????????????ß·????????????????????????? [`nginx`](https://store.docker.com/images/nginx/)??[`redis`](https://store.docker.com/images/redis/)??[`mongo`](https://store.docker.com/images/mongo/)??[`mysql`](https://store.docker.com/images/mysql/)??[`httpd`](https://store.docker.com/images/httpd/)??[`php`](https://store.docker.com/images/php/)??[`tomcat`](https://store.docker.com/images/tomcat/) ???????ßª?????????????????ß⁄???????????????? [`node`](https://store.docker.com/images/node)??[`openjdk`](https://store.docker.com/images/openjdk/)??[`python`](https://store.docker.com/images/python/)??[`ruby`](https://store.docker.com/images/ruby/)??[`golang`](https://store.docker.com/images/golang/) ??????????????????????????????????????????????????ßÿ????

???????????????????????????ß›??????ßª???????????????????? [`ubuntu`](https://store.docker.com/images/ubuntu/)??[`debian`](https://store.docker.com/images/debian/)??[`centos`](https://store.docker.com/images/centos/)??[`fedora`](https://store.docker.com/images/fedora/)??[`alpine`](https://store.docker.com/images/alpine/) ?????ßª???????????????????????????????????

??????????ß‡??????????????Docker ???????????????????? `scratch`?????????????????????????????????????????????

```dockerfile
FROM scratch
...
```

??????? `scratch` ???????????????¶∆???????¶ ¶Œ??????????????????ß’??????????????????????

?????¶ ?????????????????????????????????????????????????? [`swarm`](https://hub.docker.com/_/swarm/)??[`coreos/etcd`](https://quay.io/repository/coreos/etcd)?????? Linux ?????????????????????????ß”???????????????????????ß·???????????????????????? `FROM scratch` ??????????????ß≥?®¿???? [Go ????](https://golang.org/) ????????®≤????????????????????????????????????? Go ?????????????????????????????????

### RUN(???????)

`RUN` ?????????????????????????????????ß÷??????????`RUN` ?????????????????????????????????????

- _shell_ ?????`RUN <????>`????????????????????????????????????ß’?? Dockerfile ?ß÷? `RUN` ??????????????

```dockerfile
RUN echo '<h1>Hello, Docker!</h1>' > /usr/share/nginx/html/index.html
```

- _exec_ ?????`RUN ["????????", "????1", "????2"]`?????????????????ß÷?????

??? `RUN` ???? Shell ????????????????????????????????? Shell ???????????????????? RUN ?????????????

```dockerfile
FROM debian:jessie

RUN apt-get update
RUN apt-get install -y gcc libc6-dev make
RUN wget -O redis.tar.gz "http://download.redis.io/releases/redis-3.2.5.tar.gz"
RUN mkdir -p /usr/src/redis
RUN tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1
RUN make -C /usr/src/redis
RUN make -C /usr/src/redis install
```

???????Dockerfile ????????????????`RUN` ??????????? `RUN` ???????????????????????????????????????????????????????ßª??????ßﬂ?????`commit` ????????????????????

???????????ß’?????????? 7 ????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? ???????? Docker ????????????????

_Union FS ???????????????????? AUFS???????????®Æ??? 42 ??????????®Æ??? 127 ??_

????? `Dockerfile` ?????ß’?????????????

```dockerfile
FROM debian:jessie

RUN buildDeps='gcc libc6-dev make' \
    && apt-get update \
    && apt-get install -y $buildDeps \
    && wget -O redis.tar.gz "http://download.redis.io/releases/redis-3.2.5.tar.gz" \
    && mkdir -p /usr/src/redis \
    && tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \
    && make -C /usr/src/redis \
    && make -C /usr/src/redis install \
    && rm -rf /var/lib/apt/lists/* \
    && rm redis.tar.gz \
    && rm -r /usr/src/redis \
    && apt-get purge -y --auto-remove $buildDeps
```

??????????ß÷????????????????????????? redis ???????????????ß“??????????????????????Óï?????????????®≤??? `RUN` ????????????????????????????? `RUN` ???????? `&&` ???????????????????????????? 7 ??????? 1 ?????ß’ Dockerfile ???????????????????????????ß’ Shell ?????????????????????¶…?????

??????????????????????????ß≥?Dockerfile ??? Shell ?????¶¬??? `\` ???????ßŸ??????????? `#` ????????????????????????Áπ?ß≥????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????????????????????????????????????????? `apt` ???????????????????????????????????????????õ•???????????????????????????????????????????????????????????????????????????????????¶ ????????????????????

??????? Docker ??????????????????????????????????????????????????????????????

### COPY(???????)

> ?????
>
> **`COPY` ?????????????????? `<?°§??>` ?????/???????????????????? `<???°§??>` ¶À?®¢?**

?????

- `COPY [--chown=<user>:<group>] <?°§??>... <???°§??>`
- `COPY [--chown=<user>:<group>] ["<?°§??1>",... "<???°§??>"]`

?????

```dockerfile
COPY package.json /usr/src/app/
```

`<?°§??>` ????????????????????????????????????????? Go ?? [`filepath.Match`](https://golang.org/pkg/path/filepath/#Match) ?????ª«

```dockerfile
COPY hom* /mydir/
COPY hom?.txt /mydir/
```

`<???°§??>` ????????????????°§??????????????????????????°§???????????????? `WORKDIR` ???????????????°§????????????????????????????????????????ß’?????????

?????????????????? `COPY` ???????????????????????????????ß’???????????????????????????????????????®¢?????????????????????? Git ???ß€???????

??????????????????? `--chown=<user>:<group>` ???????????????????????????Óï

```dockerfile
COPY --chown=55:mygroup files* /mydir/
COPY --chown=bin files* /mydir/
COPY --chown=1 files* /mydir/
COPY --chown=10:11 files* /mydir/
```

### ADD(?????????????)

> ?????
>
> `ADD` ???? `COPY` ??????????????????????? `COPY` ?????????????ßª?????
>
> ???? `<?°§??>` ????????? `URL`????????????Docker ??????????????????????????? `<???°§??>`??????????????????????? `600`??????????????????????????????????????? `RUN` ????????????????????????????????????????????????????????????? `RUN` ?????ßﬂ??????????????????? `RUN` ????????? `wget` ???? `curl` ????????????????????????????????????????????????????????????????????????????®¢?
>
> ??? `<?°§??>` ???? `tar` ?????????????????? `gzip`, `bzip2` ??? `xz` ????????`ADD` ???????????????????????? `<???°§??>` ???

???ßª??????????????????????????????????????? `ubuntu` ?ßµ?

```dockerfile
FROM scratch
ADD ubuntu-xenial-core-cloudimg-amd64-root.tar.gz /
...
```

?????ßª????????????????????????????????????????????????????????????? `ADD` ???????

?? Docker ????? [Dockerfile ?????????](https://yeasy.gitbooks.io/docker_practice/content/appendix/best_practices.html) ?????????????? `COPY`????? `COPY` ????????????????????????????? `ADD` ???????????????????????????????????????????? `ADD` ?????????????????????????????????

??????????????`ADD` ??????????????ßπ?????????????????????????

????? `COPY` ?? `ADD` ??????????????????????????????ß÷???????????? `COPY` ?????????????????????????? `ADD`??

??????????????????? `--chown=<user>:<group>` ???????????????????????????Óï

```dockerfile
ADD --chown=55:mygroup files* /mydir/
ADD --chown=bin files* /mydir/
ADD --chown=1 files* /mydir/
ADD --chown=10:11 files* /mydir/
```

### CMD(????????????)

> ?????
>
> ????????????????????????Docker ?????????????????????????????????????????????????????????????ß÷?????????`CMD` ??????????????????????????????????????

`CMD` ???????? `RUN` ????????????????

- `shell` ?????`CMD <????>`
- `exec` ?????`CMD ["????????", "????1", "????2"...]`
- ?????ß“?????`CMD ["????1", "????2"...]`????????? `ENTRYPOINT` ?????? `CMD` ?????????????

???????????????????????????????????ß÷??????????????Ì‡`ubuntu` ???????? `CMD` ?? `/bin/bash`???????????? `docker run -it ubuntu` ????????????? `bash`????????????????????????ß“???????? `docker run -it ubuntu cat /etc/os-release`????????? `cat /etc/os-release` ?????ùI?????? `/bin/bash` ???????????????∑⁄?????

??????????????????? `exec` ???????????????????????? JSON ???ÔÖ??????????????? `"`????????????????

?????? `shell` ????????????????????? `sh -c` ????????????????ß≥????ª«

```dockerfile
CMD echo $HOME
```

?????????ßµ??????????

```dockerfile
CMD [ "sh", "-c", "echo $HOME" ]
```

???????????????????????????????????ßª?????????? shell ???ßﬂ???????

?? `CMD` ????®∞??????????????????ß‹?????ß÷????????????????????????????

Docker ????????????????ß÷??????????????ßµ????????????????????????????????? upstart/systemd ????????????????????ß‹?????????˛ü

?ßª?????? `CMD` ß’???

```dockerfile
CMD service nginx start
```

???????????ß‹???????????????????????????? `systemctl` ????????????????ß”??????????????ß⁄?????????????????????????????????????????????????????????????????????

?????????????????????????????????????????????????????????????????????????????????????????»…??????????????????????????????????????

????? `service nginx start` ??????????? upstart ???????????????????? `nginx` ??????????? `CMD service nginx start` ?????? `CMD [ "sh", "-c", "service nginx start"]`?????????????????? `sh`??????? `service nginx start` ?????????`sh` ?????????`sh` ????????????????????????????????

????????????????? `nginx` ???????????????????????????ß≥????ª«

```dockerfile
CMD ["nginx", "-g", "daemon off;"]
```

### ENTRYPOINT(????)

`ENTRYPOINT` ?????? `RUN` ????????????? `exec` ????? `shell` ?????

`ENTRYPOINT` ?????? `CMD` ???????????????????????????????`ENTRYPOINT` ??????????????????????? `CMD` ???????????????? `docker run` ????? `--entrypoint` ???????

??????? `ENTRYPOINT` ??`CMD` ?????????????????????????????????????? `CMD` ????????????????? `ENTRYPOINT` ??????—ˆ?????????????????

```bash
<ENTRYPOINT> "<CMD>"
```

??????? `CMD` ?????????? `ENTRYPOINT` ??????? `<ENTRYPOINT> "<CMD>"` ??????????????????????????????

#### ??????????????????????????

??????????????????????????? IP ???????????????? `CMD` ??????

```dockerfile
FROM ubuntu:18.04
RUN apt-get update \
    && apt-get install -y curl \
    && rm -rf /var/lib/apt/lists/*
CMD [ "curl", "-s", "https://ip.cn" ]
```

??????????? `docker build -t myip .` ?????????????????????????????????? IP????????ßµ?

```bash
$ docker run myip
??? IP??61.148.226.66 ??????????? ???
```

?????????????????????????????????????????????????ß”????????????????????????????????? `CMD` ?ß·???????????????? `curl`?????????????????? HTTP ??????????????? `-i` ???????????????????? `-i` ?????? `docker run myip` ???

```bash
$ docker run myip -i
docker: Error response from daemon: invalid header field value "oci runtime error: container_linux.go:247: starting container process caused \"exec: \\\"-i\\\": executable file not found in $PATH\"\n".
```

????????????????????????????`executable file not found`????????????????????????????? `command`??????????ùI `CMD` ???????????????? `-i` ?ùI??????? `CMD`?????????????????? `curl -s https://ip.cn` ???µµ?? `-i` ??????????????????????????

????????????????? `-i` ????????????????????????????????????

```bash
$ docker run myip curl -s https://ip.cn -i
```

????????????????????????? `ENTRYPOINT` ???????????????????????????? `ENTRYPOINT` ????????????

```dockerfile
FROM ubuntu:18.04
RUN apt-get update \
    && apt-get install -y curl \
    && rm -rf /var/lib/apt/lists/*
ENTRYPOINT [ "curl", "-s", "https://ip.cn" ]
```

????????????????????? `docker run myip -i`??

```bash
$ docker run myip
??? IP??61.148.226.66 ??????????? ???

$ docker run myip -i
HTTP/1.1 200 OK
Server: nginx/1.8.0
Date: Tue, 22 Nov 2016 05:12:40 GMT
Content-Type: text/html; charset=UTF-8
Vary: Accept-Encoding
X-Powered-By: PHP/5.6.24-1~dotdeb+7.1
X-Cache: MISS from cache-2
X-Cache-Lookup: MISS from cache-2:80
X-Cache: MISS from proxy-2_6
Transfer-Encoding: chunked
Via: 1.1 cache-2:80, 1.1 proxy-2_6:8006
Connection: keep-alive

??? IP??61.148.226.66 ??????????? ???
```

???????????¶√?????????????????? `ENTRYPOINT` ??`CMD` ???????????????????? `ENTRYPOINT`???????? `-i` ??????? `CMD`????????????????? `curl`?????????????????ßπ????

#### ?????????????????????????

???????????????????????????ßª????????????????????ßª?????????

???? `mysql` ????????????????ßª????????®¢???????????????ßª???????????? mysql ?????????????????

?????????????????? `root` ?????????????????????????????????????????? `root` ???????ßª??????????????????ß›?????????????????????????????????????????????????? `root` ?????ßµ??????????

??ßª?????????????? `CMD` ????????? `CMD` ?????????????????????????????????????????????ß’?????????????? `ENTRYPOINT` ?????ßµ?????????????????????????? `<CMD>`??????????????????ß≥??????????? `redis` ?ß‡???????????

```dockerfile
FROM alpine:3.4
...
RUN addgroup -S redis && adduser -S -G redis redis
...
ENTRYPOINT ["docker-entrypoint.sh"]

EXPOSE 6379
CMD [ "redis-server" ]
```

?????????????? redis ??????? redis ????????????????? `ENTRYPOINT` ? `docker-entrypoint.sh` ?????

```bash
#!/bin/sh
...
# allow the container to be started with `--user`
if [ "$1" = 'redis-server' -a "$(id -u)" = '0' ]; then
    chown -R redis .
    exec su-exec redis "$0" "$@"
fi

exec "$@"
```

???????????????? `CMD` ?????????ßÿ??????? `redis-server` ????????ß›??? `redis` ????????????????????????????? `root` ?????ß≥????ª«

```bash
$ docker run -it redis id
uid=0(root) gid=0(root) groups=0(root)
```

### ENV(???????????)

> ?????`ENV` ??????????????????????????????????????? `RUN`?????????????????????????????????????????????

?????

- `ENV <key> <value>`
- `ENV <key1>=<value1> <key2>=<value2>...`

??? 1??

```dockerfile
ENV VERSION=1.0 DEBUG=on \
    NAME="Happy Feet"
```

????????????????¶À??ßµ????????ß·????????????????????????? Shell ?????????????

??? 2??

?????????????????????????????ßµ?????????????????????????????? `node` ???? `Dockerfile` ?ßµ??????????????????

```dockerfile
ENV NODE_VERSION 7.2.0

RUN curl -SLO "https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-x64.tar.xz" \
  && curl -SLO "https://nodejs.org/dist/v$NODE_VERSION/SHASUMS256.txt.asc" \
  && gpg --batch --decrypt --output SHASUMS256.txt SHASUMS256.txt.asc \
  && grep " node-v$NODE_VERSION-linux-x64.tar.xz\$" SHASUMS256.txt | sha256sum -c - \
  && tar -xJf "node-v$NODE_VERSION-linux-x64.tar.xz" -C /usr/local --strip-components=1 \
  && rm "node-v$NODE_VERSION-linux-x64.tar.xz" SHASUMS256.txt.asc SHASUMS256.txt \
  && ln -s /usr/local/bin/node /usr/local/bin/nodejs
```

???????????????????? `NODE_VERSION`?????? `RUN` ??????????? `$NODE_VERSION` ?????ß”???????????????????????????????∑⁄????????????? `7.2.0` ?????`Dockerfile` ??????????????????

????????????????????????? `ADD`??`COPY`??`ENV`??`EXPOSE`??`LABEL`??`USER`??`WORKDIR`??`VOLUME`??`STOPSIGNAL`??`ONBUILD`??

????????????ß“???ß‡???????????????????????????????????????????????????????? `Dockerfile` ?????????????????®∞??????????????®¿?

### ARG(????????)

> ?????
>
> `Dockerfile` ?ß÷? `ARG` ?????????????????????????????????????????????????? `docker build` ???? `--build-arg <??????>=<?>` ???????
>
> ?????????? `ENV` ??ßπ??????????????????????????????????`ARG` ?????????????????????????????????????????????????ßª???????????????????????? `ARG` ???????????????????? `docker history` ??????????????????

?????`ARG <??????>[=<????>]`

?? 1.13 ????∑⁄????? `--build-arg` ?ß÷?????????????? `Dockerfile` ???? `ARG` ???????????—ˆ??????? `--build-arg` ???????????????? `Dockerfile` ????????????????????ß“????????????????????? 1.13 ??????????????????????????????????????????????????????????????????????? CI ?????????????????????????? `Dockerfile` ????????ß—???????????????????????? Dockerfile ??????????

### VOLUME(??????????)

?????

- `VOLUME ["<°§??1>", "<°§??2>"...]`
- `VOLUME <°§??>`

???????????????????????????????????õ•??????ß’???????????????????????—ƒ?????????????????????????????(volume)?ßµ?????????????????????? Docker ?????˛ü????????????????????????????????????????? `Dockerfile` ?ßµ????????????????ßª?????????????????????????????????????????????????????????ßµ????????????õ•??ß’??????????

```dockerfile
VOLUME /data
```

????? `/data` ???????????????????????????¶ ??? `/data` ??ß’?????????????????????õ•???????????????õ•??????????????????????????????????????®¢????ª«

```dockerfile
docker run -d -v mydata:/data xxxx
```

???????????ßµ???????? `mydata` ??????????????? `/data` ???¶À???????? `Dockerfile` ?ßÿ?????????????????®¢?

### EXPOSE(??????)

> ?????
>
> `EXPOSE` ??????????????????????????????????????????????????????????????????????????????????? Dockerfile ??ß’???????????????????????????????????????????????????????????????????????????????????????????????????????????????? `docker run -P` ?????????????? `EXPOSE` ?????
>
> ??? `EXPOSE` ???????????? `-p <???????>:<???????>` ?????????`-p`??????????????????????????—ˆ?????????????????????????????????? `EXPOSE` ????????????????????????????????????????????????ßÿ?????

?????`EXPOSE <???1> [<???2>...]`??

### WORKDIR(?????????)

> ?????
>
> ??? `WORKDIR` ????????????????????????????????????????????????????????????????????????`WORKDIR` ???????????

?????`WORKDIR <??????°§??>`??

??? 1??

?????ßª???????????????? `Dockerfile` ????? Shell ???????ß’????????????????????????????????????

```dockerfile
RUN cd /app
RUN echo "hello" > world.txt
```

???????? `Dockerfile` ???ß€??????????ß‹????????? `/app/world.txt` ?????????????????? `hello`?????????????? Shell ?ßµ?????????????????????ß›??????????????????????????????????????????????? `Dockerfile` ?ßµ??????? `RUN` ???????ß›?????????????????????????????????????? `Dockerfile` ???????õ•??????????????????

????????? `RUN` ???????????????????????˛û??????õ•??????????????? `RUN cd /app` ????ßﬂ???????????????????????????????Å£?????????????????¶ ????????????????????????????????????????????????????????????????????????????????????????ß÷????Å£??

??????????????????????????¶À???????????? `WORKDIR` ??˛ü

### USER(?????????)

> ?????
>
> `USER` ???? `WORKDIR` ??????????º€??????????????`WORKDIR` ???Åa??????`USER` ?????????????? `RUN`, `CMD` ??? `ENTRYPOINT` ?????????????
>
> ??????? `WORKDIR` ?????`USER` ?????????ß›?????????????????????????????????????????????ß›???

?????`USER <?????>[:<?????>]`

??? 1??

```dockerfile
RUN groupadd -r redis && useradd -r -g redis redis
USER redis
RUN [ "redis-server" ]
```

????? `root` ??ß÷??????????????????????????????????????????????????????????????????????? `su`???? `sudo`????ßª?????????˙ë????????????? TTY ??????????????????????? [`gosu`](https://github.com/tianon/gosu)??

```dockerfile
# ???? redis ?????????? gosu ?????????????????
RUN groupadd -r redis && useradd -r -g redis redis
# ???? gosu
RUN wget -O /usr/local/bin/gosu "https://github.com/tianon/gosu/releases/download/1.7/gosu-amd64" \
    && chmod +x /usr/local/bin/gosu \
    && gosu nobody true
# ???? CMD?????????????????
CMD [ "exec", "gosu", "redis", "redis-server" ]
```

### HEALTHCHECK(???????)

?????

- `HEALTHCHECK [???] CMD <????>`?????®π???????????????????
- `HEALTHCHECK NONE`??????????????ßﬂ???????????????ß·??????¶≈??ÅŸ????????

`HEALTHCHECK` ???????? Docker ?????¶Õ????ßÿ?????????????????????? Docker 1.12 ?????????˛ü

????? `HEALTHCHECK` ??????Docker ?????????????????????????????????ßÿ???????????????????????????????????????????????????????????????????????????????????????????????????????? 1.12 ?????Docker ????????????????????????????????????????????ß”????????????????????????????????????

???? 1.12 ???Docker ???? `HEALTHCHECK` ??????????????????????????????????ßÿ??????????????????????????????????????????????????

???????????????? `HEALTHCHECK` ?????????????????????????? `starting`???? `HEALTHCHECK` ??????????? `healthy`????????????????????????? `unhealthy`??

`HEALTHCHECK` ??????????

- `--interval=<???>`?????¶Õ??????????????? 30 ??
- `--timeout=<???>`????????????????ß‘?????????????????????¶Õ?????????????????? 30 ??
- `--retries=<????>`??????????????????????????????? `unhealthy`????? 3 ?¶±?

?? `CMD`, `ENTRYPOINT` ?????`HEALTHCHECK` ??????????¶≤????ß’?????????????????ßπ??

?? `HEALTHCHECK [???] CMD` ?????????????? `ENTRYPOINT` ???????? `shell` ??????? `exec` ?????????????????????¶Õ????????????`0`???????`1`??????`2`????????????????????

?????????ß⁄???????????? Web ????????????????????????ßÿ??? Web ???????????????????????????? `curl` ???????ßÿ???? `Dockerfile` ?? `HEALTHCHECK` ???????ß’??

```dockerfile
FROM nginx
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
HEALTHCHECK --interval=5s --timeout=3s \
  CMD curl -fs http://localhost/ || exit 1
```

??????????????? 5 ??????¶≤??????????????????????????????????????????????????????? 3 ?????????????????????? `curl -fs http://localhost/ || exit 1` ?????????????˛ü

??? `docker build` ?????????????

```bash
$ docker build -t myweb:v1 .
```

??????????????????????????

```bash
$ docker run -d --name web -p 80:80 myweb:v1
```

?????ß⁄??????????? `docker container ls` ???????????? `(health: starting)`??

```bash
$ docker container ls
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                            PORTS               NAMES
03e28eb00bd0        myweb:v1            "nginx -g 'daemon off"   3 seconds ago       Up 2 seconds (health: starting)   80/tcp, 443/tcp     web
```

?????????????? `docker container ls`??????????????Å£??? `(healthy)`??

```bash
$ docker container ls
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                    PORTS               NAMES
03e28eb00bd0        myweb:v1            "nginx -g 'daemon off"   18 seconds ago      Up 16 seconds (healthy)   80/tcp, 443/tcp     web
```

?????????????????????????????????????? `(unhealthy)`??

???????????????????????????????? `stdout` ??? `stderr`???????õ•??????????????? `docker inspect` ??????

```bash
$ docker inspect --format '{{json .State.Health}}' web | python -m json.tool
{
    "FailingStreak": 0,
    "Log": [
        {
            "End": "2016-11-25T14:35:37.940957051Z",
            "ExitCode": 0,
            "Output": "<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n<style>\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n</style>\n</head>\n<body>\n<h1>Welcome to nginx!</h1>\n<p>If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.</p>\n\n<p>For online documentation and support please refer to\n<a href=\"http://nginx.org/\">nginx.org</a>.<br/>\nCommercial support is available at\n<a href=\"http://nginx.com/\">nginx.com</a>.</p>\n\n<p><em>Thank you for using nginx.</em></p>\n</body>\n</html>\n",
            "Start": "2016-11-25T14:35:37.780192565Z"
        }
    ],
    "Status": "healthy"
}
```

### ONBUILD(?????????????)

?????`ONBUILD <???????>`??

`ONBUILD` ??????????????????????????????????? `RUN`, `COPY` ???????ßª?????????????????????ß≥???ß÷????????????????????????????????????????ß≥?

`Dockerfile` ?ß÷?????????????????????????????¶∑?? `ONBUILD` ??????????????????????????

????????????? Node.js ??ß’????????????????? Node.js ??? `npm` ???ß—??????????????????®¢????????????? `package.json` ?????????????????????????? `npm install` ???????????????????????????????? `npm start`????????®¢?????????????????ß’ `Dockerfile`??

```dockerfile
FROM node:slim
RUN mkdir /app
WORKDIR /app
COPY ./package.json /app
RUN [ "npm", "install" ]
COPY . /app/
CMD [ "npm", "start" ]
```

????? `Dockerfile` ??? Node.js ??????????????????????????????????????????ß≥??????????????ß÷???? Node.js ???????????????????????? `Dockerfile` ?????????????????????ß÷???????????????????????????????∑⁄????????????????????????????????????????

???????? Node.js ?????????????ßµ???????? `Dockerfile` ?????????????????????????????????????????????????????? `Dockerfile`????¶…?????????????? ???????????????????????????????????? `Dockerfile` ??????????????????????????????????????????????????? `Dockerfile`?????????????? `Dockerfile` ???????????

?????????????????????????????????????????????????????????????????????????????????? `Dockerfile`??Å£??????????????????????????????????????????????????????????????????? `Dockerfile` ???????

```dockerfile
FROM node:slim
RUN mkdir /app
WORKDIR /app
CMD [ "npm", "start" ]
```

???????????????????????®Æ??????????????????????????????????????? `my-node` ???????????????????? `Dockerfile` ??????

```dockerfile
FROM my-node
COPY ./package.json /app
RUN [ "npm", "install" ]
COPY . /app/
```

????????Å£??????????????? `Dockerfile` ?????????????ß›????????????

??????????????????ß≥????????????????????? `Dockerfile` ??????ßª?????????????????? `npm install` ????????ßª?????????????????? `RUN` ???????????????????????ùp??????????? `./package.json`????????????????????????????????????????????????????? `Dockerfile` ??? 4 ??????Å£??????????????????Å£????????????

`ONBUILD` ????????????????????? `ONBUILD` ????ß’??????????? `Dockerfile`:

```dockerfile
FROM node:slim
RUN mkdir /app
WORKDIR /app
ONBUILD COPY ./package.json /app
ONBUILD RUN [ "npm", "install" ]
ONBUILD COPY . /app/
CMD [ "npm", "start" ]
```

????????????? `Dockerfile`????????¶Õ?????????????? `ONBUILD`????????????????????????????ß”???????ß≥???????????? `Dockerfile` ?????????

```dockerfile
FROM my-node
```

????????????ß≥??????????????ßµ???????????ß÷? `Dockerfile` ???????????????????????????? `ONBUILD` ??????ßµ?????????????????????????????????????? `npm install`????????????

## ???®≤?????

- [Dockerfie ??????](https://docs.docker.com/engine/reference/builder/)
- [Dockerfile ?????????](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)
- [Docker ??????? Dockerfile](https://github.com/docker-library/docs)
- [Dockerfile ??????](https://yeasy.gitbooks.io/docker_practice/content/image/dockerfile/)
