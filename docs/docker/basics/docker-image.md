# Docker ????

<!-- TOC depthFrom:2 depthTo:3 -->

- [???????](#???????)
    - [????](#????)
- [?ß‘?????](#?ß‘?????)
    - [???????](#???????)
    - [????????](#????????)
    - [?ßﬁ????](#?ßﬁ????)
    - [?ß‘????????](#?ß‘????????)
    - [???????????](#???????????)
- [??????????](#??????????)
    - [?? ID???????????????????](#??-id???????????????)
    - [Untagged ?? Deleted](#untagged-??-deleted)
    - [?? docker image ls ?????????](#??-docker-image-ls-?????????)
    - [CentOS/RHEL ????????????????](#centosrhel-????????????????)
- [??? Dockerfile ???????](#???-dockerfile-???????)
    - [????????](#????????)
    - [????????????Context??](#???????????context)
    - [???? `docker build` ???°¬?](#????-docker-build-???°¬?)

<!-- /TOC -->

## ???????

????????[Docker Hub](https://hub.docker.com/explore/) ???ß’??????????????????????????????????????????ßª????

?? Docker ??????????????????? `docker pull`?????????????

```bash
docker pull [???] [Docker Registry ???[:????]/]?????[:???]
```

?????????????? `docker pull --help` ????????????????????????????????

- Docker ?????????????????????? `<????/IP>[:????]`????????? Docker Hub??
- ??????????????????????????????????????? `<?????>/<?????>`?????? Docker Hub???????????????????????? `library`?????????????

???ª«

```bash
$ docker pull ubuntu:18.04
18.04: Pulling from library/ubuntu
bf5d46315322: Pull complete
9f13e0ac480c: Pull complete
e8988b5b3097: Pull complete
40af181810e7: Pull complete
e6f7c7e5c03e: Pull complete
Digest: sha256:147913621d9cdea08853f6ba9116c2e27a3ceffecf3b492983ae97c3d643fbbe
Status: Downloaded newer image for ubuntu:18.04
```

?????????????ß⁄??? Docker ????????????????? Docker Hub ?????????????????? `ubuntu:18.04`????????????????? `library/ubuntu` ????ß“??? `18.04` ?????

??????????ß·??????????????????õ•???????????????õ•?????®¿??????????????????????????????????????ß⁄?????????? ID ??? 12 ¶À????????????????????????????? `sha256` ?????????????????????

????????????????????????????????????? ID ??? `sha256` ??????????????????????????????????????????????¶ ???? bug??????∑⁄????????????????????????????????????????????¶ ?????????????????????????????????????

*????? Docker Hub ?????????????????????? ????????? ??????®π???????*

### ????

???????????????????????????????????????????????????????? `ubuntu:18.04` ???????????????????????? `bash` ??????ßﬂ????????????????????????????˛ü

```bash
$ docker run -it --rm \
    ubuntu:18.04 \
    bash

root@e7009c6ce357:/# cat /etc/os-release
NAME="Ubuntu"
VERSION="18.04.1 LTS (Bionic Beaver)"
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME="Ubuntu 18.04.1 LTS"
VERSION_ID="18.04"
HOME_URL="https://www.ubuntu.com/"
SUPPORT_URL="https://help.ubuntu.com/"
BUG_REPORT_URL="https://bugs.launchpad.net/ubuntu/"
PRIVACY_POLICY_URL="https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"
VERSION_CODENAME=bionic
UBUNTU_CODENAME=bionic
```

`docker run` ??????????????????????????????? [????](https://yeasy.gitbooks.io/docker_practice/content/container) ?????????????????????????????????????????????

- `-it`????????????????????? `-i`?????????????????? `-t` ?????????????????? `bash` ????ßª?????????????????????????????????
- `--rm`???????????????????????????????????????????????????????????????????????????????????? `docker rm`??????????????????ß⁄?????????????????????????????????????? `--rm` ????????????
- `ubuntu:18.04`????????? `ubuntu:18.04` ?????????????????????
- `bash`????????????????**????**??????????????ß⁄?????? Shell?????????? `bash`??

??????????????????? Shell ???????????¶ ?????????˛ü????????????? `cat /etc/os-release`?????? Linux ????????????∑⁄????????????????????????????? `Ubuntu 18.04.1 LTS` ????

?????????? `exit` ??????????????

## ?ß‘?????

????ß‘??????????????????????? `docker image ls` ???˛ü

```bash
$ docker image ls
REPOSITORY           TAG                 IMAGE ID            CREATED             SIZE
redis                latest              5f515359c7f8        5 days ago          183 MB
nginx                latest              05a60462f8ba        5 days ago          181 MB
mongo                3.2                 fe9198c04d62        5 days ago          342 MB
<none>               <none>              00285df0df87        5 days ago          342 MB
ubuntu               18.04               f753707788c5        4 weeks ago         127 MB
ubuntu               latest              f753707788c5        4 weeks ago         127 MB
ubuntu               14.04               1e0c3dd64ccd        4 weeks ago         188 MB
```

?ß“?????? `?????`??`???`??`???? ID`??`???????` ??? `????????`??

???ß”????????????????????????????????????**???? ID** ????????¶∑?????????????????????**???**??????????????????ßµ??????????? `ubuntu:18.04` ?? `ubuntu:latest` ???????? ID???????????????????????

### ???????

?????????????????????????????????? Docker Hub ???????????ß≥????????Ì‡`ubuntu:18.04` ?????ß≥?????????? `127 MB`???????? [Docker Hub](https://hub.docker.com/r/library/ubuntu/tags/) ???????? `50 MB`????????? Docker Hub ?????????????????????????????????????????ß‡????????????????????? Docker Hub ????????ß≥?????◊œ???ß⁄????????????ß≥???? `docker image ls` ??????????????????????????ß≥?????????????????????????????????????????????????????????????????????ß≥??

?????????????????????`docker image ls` ?ß“??ß÷??????????????????ß‡?????????????????? Docker ????????õ•????????????ß≥?????????????????????????????????????????ß€????????? Docker ??? Union FS???????????????????????????????????????????????????ß“????ß≥??????ß≥???

??????????????????????????????????????????????

```bash
$ docker system df

TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE
Images              24                  0                   1.992GB             1.992GB (100%)
Containers          1                   0                   62.82MB             62.82MB (100%)
Local Volumes       9                   0                   652.2MB             652.2MB (100%)
Build Cache                                                 0B                  0B
```

### ????????

?????????ß“??ßµ???????????????????????????????ß”?????????ß“??????? `<none>`????

```bash
<none>               <none>              00285df0df87        5 days ago          342 MB
```

?????????????ß‡???????????????? `mongo:3.2`????????????????????????°„∑⁄?????? `docker pull mongo:3.2` ???`mongo:3.2` ????????????????????????????????????????????????????????????????? `<none>`?????? `docker pull` ????????????????`docker build` ???????????????????????????????????????????????????????????????????? `<none>` ??????????????????????? **????????(dangling image)** ?????????????????????????????

```bash
$ docker image ls -f dangling=true
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
<none>              <none>              00285df0df87        5 days ago          342 MB
```

??????????????????????????????????????????????????????????????????

```bash
$ docker image prune
```

### ?ßﬁ????

????????????????????????Docker ?????? **?ßﬁ????**?????????????????????????ßª???????ßﬁ???????? `docker image ls` ?ß“?????????????????????????????ßﬁ????????????ß‡???????????? `-a` ??????

```bash
$ docker image ls -a
```

???????????????????????????????????????ßª??????????????ßﬁ???????????????????????????ßª????????????????????????????????????????????????????ßª????????????????????????????????????ÔÖ????ßª???????????????????????????????????ß‘?????????????????????????????????????????ßª???????????????ßª???????ßﬁ????????????????

### ?ß‘????????

?????¶ ¶¬???????????`docker image ls` ???ß‘????ßÿ????????????????????????ß‘????????`docker image ls` ?ß‹®π????????????????????????Óï

?????????ß‘?????

```bash
$ docker image ls ubuntu
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
ubuntu              18.04               f753707788c5        4 weeks ago         127 MB
ubuntu              latest              f753707788c5        4 weeks ago         127 MB
ubuntu              14.04               1e0c3dd64ccd        4 weeks ago         188 MB
```

?ß‘???????????????????????????????

```bash
$ docker image ls ubuntu:18.04
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
ubuntu              18.04               f753707788c5        4 weeks ago         127 MB
```

????????`docker image ls` ?????????????????? `--filter`???????ß’ `-f`???????????????????®¥????????ß‘???????????°¬????????ß⁄?????°¬??????Ì‡????????????? `mongo:3.2` ????????????????????????

```bash
$ docker image ls -f since=mongo:3.2
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
redis               latest              5f515359c7f8        5 days ago          183 MB
nginx               latest              05a60462f8ba        5 days ago          181 MB
```

??????¶À????????????????????? `since` ???? `before` ???®¿?

????????????????????? `LABEL`??????????? `LABEL` ???????

```bash
$ docker image ls -f label=com.example.version=0.1
...
```

### ???????????

?????????`docker image ls` ???????????????????????????????????????ßª????????Ì‡????????????????????????????? `docker image ls` ?????ß÷?????????? ID ?ß‘??????????????? `docker image rm` ???????????????????????ßª???????????????? `-q` ??????

```bash
$ docker image ls -q
5f515359c7f8
05a60462f8ba
fe9198c04d62
00285df0df87
f753707788c5
f753707788c5
1e0c3dd64ccd
```

`--filter` ??? `-q` ???????????¶∂?? ID ?ß“???????????? `docker` ???????????????????????????????????????????????? Docker ????????®¥????ßŸ?????????????????????????????????????ß·???????????????????????????????????????????????????????????????°¬???

?????ßª??????????????????????????????????ßµ??????????ß“???????????????????????????????????? [Go ???????](https://gohugo.io/templates/go-templates/)??

???Ì‡??????????????ß‘??????????????????????ID????????

```bash
$ docker image ls --format "{{.ID}}: {{.Repository}}"
5f515359c7f8: redis
05a60462f8ba: nginx
fe9198c04d62: mongo
00285df0df87: <none>
f753707788c5: ubuntu
f753707788c5: ubuntu
1e0c3dd64ccd: ubuntu
```

???????????????????????ß“????ßµ???????????????????????ßµ?

```bash
$ docker image ls --format "table {{.ID}}\t{{.Repository}}\t{{.Tag}}"
IMAGE ID            REPOSITORY          TAG
5f515359c7f8        redis               latest
05a60462f8ba        nginx               latest
fe9198c04d62        mongo               3.2
00285df0df87        <none>              <none>
f753707788c5        ubuntu              18.04
f753707788c5        ubuntu              latest
1e0c3dd64ccd        ubuntu              14.04
```

## ??????????

????????????????????? `docker image rm` ???????????

```
$ docker image rm [???] <????1> [<????2> ...]
```

### ?? ID???????????????????

???ßµ?`<????>` ?????? `????? ID`??`???? ID`??`??????` ???? `??????`??

??????????????ßª????

```bash
$ docker image ls
REPOSITORY                  TAG                 IMAGE ID            CREATED             SIZE
centos                      latest              0584b3d2cf6d        3 weeks ago         196.5 MB
redis                       alpine              501ad78535f0        3 weeks ago         21.03 MB
docker                      latest              cf693ec9b5c7        3 weeks ago         105.1 MB
nginx                       latest              e43d811ce2f4        5 weeks ago         181.5 MB
```

????????????????? ID?????? `?? ID`??????????????????????????®Æ? ID??????????????????????????????????? `?? ID` ?????????`docker image ls` ????ß‘?????????? ID ????????3????????????????????????????????

??????????????????? `redis:alpine` ?????????ßµ?

```bash
$ docker image rm 501
Untagged: redis:alpine
Untagged: redis@sha256:f1ed3708f538b537eb9c2a7dd50dc90a706f7debd7e1196c9264edeea521a86d
Deleted: sha256:501ad78535f015d88872e13fa87a828425117e3d28075d0c117932b05bf189b7
Deleted: sha256:96167737e29ca8e9d74982ef2a0dda76ed7b430da55e321c071f0dbff8c2899b
Deleted: sha256:32770d1dcf835f192cafd6b9263b7b597a1778a403a109e2cc2ee866f74adf23
Deleted: sha256:127227698ad74a5846ff5153475e03439d96d4b1c7f2a449c7a826ef74a2d2fa
Deleted: sha256:1333ecc582459bac54e1437335c0816bc17634e131ea0cc48daa27d32c75eab3
Deleted: sha256:4fc455b921edf9c4aea207c51ab39b10b06540c8b4825ba57b3feed1668fa7c7
```

???????????`??????`??????? `<?????>:<???>`???????????

```bash
$ docker image rm centos
Untagged: centos:latest
Untagged: centos@sha256:b2f9d1c0ff5f87a4743104d099a3d561002ac500db1b9bfa02a783a46e0d366c
Deleted: sha256:0584b3d2cf6d235ee310cf14b54667d889887b838d3f3d3033acd70fc3c48b8a
Deleted: sha256:97ca462ad9eeae25941546209454496e1d66749d53dfa2ee32bf1faabd239d38
```

????????????????? `??????` ???????

```bash
$ docker image ls --digests
REPOSITORY                  TAG                 DIGEST                                                                    IMAGE ID            CREATED             SIZE
node                        slim                sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228   6e0c4c8e3913        3 weeks ago         214 MB

$ docker image rm node@sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228
Untagged: node@sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228
```

### Untagged ?? Deleted

?????????????????????????????????????????????????????????? `Untagged`????????? `Deleted`????????????????????¶∑???????? ID ???????????????????ßÿ???????

?????????????????????????????????????????????????????????????????????????????????????????ß‡?????????????????????????? `Untagged` ???????????????????????????????????????????????????????????ß“????????????????????????????????? `Delete` ??????????????????????ß÷? `docker image rm`?????????????????????ß·????????????????????????

??????????ß÷??????????????????????????????????»…??????????????????????õ•????????????????????????????????????¶Õ????ßÿ???????????????????????????????????ß·???????????????????????????????????????????????????????®∞??????????????¶ ¶¬??????????????????????????????????????????????????????????ß“??????????????????????????????????????????????????????????? `docker pull` ???????????????????

????????????????????????????????????????????????????????????????????????????????????ßµ??????????????????????????????????????????????????????????????õ•?????????????õ•??????ß÷????????????????????????????????????????????????????ßª??????????????????????????????????????????

### ?? docker image ls ?????????

??????????ßﬂ??????????????????????? `docker image ls -q` ???????? `docker image rm`?????????????????????????????????????????ß“??????????????????ß“???????????®¥?????®¢?

???Ì‡?????????????ß”????? `redis` ?????

```bash
$ docker image rm $(docker image ls -q redis)
```

????????????? `mongo:3.2` ???????

```bash
$ docker image rm $(docker image ls -q -f before=mongo:3.2)
```

?????????????????? Linux ?????ß÷???????????????????????

### CentOS/RHEL ????????????????

?? Ubuntu/Debian ???? `UnionFS` ?????????? `aufs` ???? `overlay2`???? CentOS ?? RHEL ??????????????????????????????????????? `devicemapper` ???????? LVM ???ßª???????????õ•??????????????????????????????????????????????????????Docker ????? CentOS/RHEL ?????????? `devicemapper`????????????????? `devicemapper`?????????????????????ıÙ????????? `loop-lvm`????????????????????????????????????? Docker?????????????¶∑????????????Óï???? `loop-lvm` ?????????????????????????????????????????? `docker info` ?ßÿ?????????????????????????????????????????????ıÙ?? `devicemapper` ???????õ•??????????????????????????? `direct-lvm`??

??????????????????`devicemapper` + `loop-lvm` ?????????????????????????????????????????????????®¥????ß›???? `/var/lib/docker/devicemapper/devicemapper/data` ????????????????????????????????????????????????????????????ßπ????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

??????? CentOS/RHEL ??????????????ß—???? `UnionFS` ???????????????? `direct-lvm` ?? `devicemapper`?????????????????????????????????

*????????????? CentOS 7 ?ß’???? backports ?????? overlay ?????????? CentOS ???????????????????????????????????????????®¢?*

## ??? Dockerfile ???????

????? `docker commit` ?????ßµ?????????????????????????????????????????????®¢??????????????????????????????????????????????ß’???????????????????????????????????????????????????????????????????????????????????????????????? Dockerfile??

Dockerfile ?????????????????????????????**???(Instruction)**???????????????????????????????????????®∞??????¶…?????

?????????? `nginx` ??????????????????? Dockerfile ???????

???????????ßµ??????????????????????? `Dockerfile`??

```bash
$ mkdir mynginx
$ cd mynginx
$ touch Dockerfile
```

?????????

```dockerfile
FROM nginx
RUN echo '<h1>Hello, Docker!</h1>' > /usr/share/nginx/html/index.html
```

??? Dockerfile ????????????ß≥??ùp???????????`FROM` ?? `RUN`??

### ????????

?????????????????????? nginx ????? Dockerfile ????????????????????? Dockerfile ?????????????????????????????®¿?

?? `Dockerfile` ???????????ßµ?

```bash
$ docker build -t nginx:v3 .
Sending build context to Docker daemon 2.048 kB
Step 1 : FROM nginx
 ---> e43d811ce2f4
Step 2 : RUN echo '<h1>Hello, Docker!</h1>' > /usr/share/nginx/html/index.html
 ---> Running in 9cdc27646c7b
 ---> 44aa4490ce2c
Removing intermediate container 9cdc27646c7b
Successfully built 44aa4490ce2c
```

??????????????ßµ???????????????????????????????? `Step 2` ?ßµ?????????????????????`RUN` ???????????????? `9cdc27646c7b`??????????????????????????????? `44aa4490ce2c`???????????????????????? `9cdc27646c7b`??

????????????? `docker build` ??????ß‡?????????????

```bash
docker build [???] <??????°§??/URL/->
```

??????????????????????????? `-t nginx:v3`?????????????????????????? `nginx:v2` ???????????????????????? `nginx:v2` ?????

### ????????????Context??

?????????? `docker build` ???????????? `.`??`.` ???????????? `Dockerfile` ??????????????????????????°§????????? `Dockerfile` ????°§??????????????????????????????????????????????????????????**??????°§??**??????????????????

???????????? `docker build` ????????Docker ?????????? Docker ???ó§???????????????????????????Docker ????????????? REST API??????? [Docker Remote API](https://docs.docker.com/engine/reference/api/docker_remote_api/)?????? `docker` ????????????????????????????? API ?? Docker ???ù©??????????????????????????????????????????????ß⁄??? `docker` ???????????????ßÿ???????????????????????Docker ???ó•??®¿????????? C/S ??????????????????????? Docker ?????????????

????????ß‡???????????????ßÿ????????? `RUN` ???????????????????ßª?????????????????????? `COPY` ??˛û`ADD` ??????? `docker build` ??????????????????????????????????????????? Docker ?????ß€???????????????????/?????????ßµ???¶¬????°¬???????????????

??????????????????˛ü??????????????????????????????????°§????`docker build` ?????????°§?????°§????????????????????????? Docker ???µµ???? Docker ??????????????????????????®¥????????????????????

????? `Dockerfile` ?????ß’??

```Dockerfile
COPY ./package.json /app/
```

?????????????? `docker build` ?????????????? `package.json`?????????? `Dockerfile` ????????? `package.json`????????? **???????context??** ????? `package.json`??

????`COPY` ????????ß÷???????°§??????*???°§??*?????????????????????? `COPY ../package.json /app` ???? `COPY /opt/xxxx /app` ?????????????????ßª°§???????????????????¶∂??Docker ????????????ßª¶À???????????????????ßª??????????????????????????????

?????????????????? `docker build -t nginx:v3 .` ?ß÷???? `.`?????????????????????????`docker build` ?????????????????????? Docker ?????????????????

?????? `docker build` ???????????????????????????????????????

```bash
$ docker build -t nginx:v3 .
Sending build context to Docker daemon 2.048 kB
...
```

????????????????????????????????ßª??????????????ßª?????????? `COPY /opt/xxxx /app` ?????????????? `Dockerfile` ????????????????????????? `docker build` ??ß‹???????????? GB ??????????????????????????????????????????????????? `docker build`????????????????????????

???????????? `Dockerfile` ????????????????????????????????????????????????????????????????????????????????????ßª???????????????????? Docker ???ó®????????? `.gitignore` ???????ß’??? `.dockerignore`?????????????????????????????????? Docker ??????

????????????????? `.` ????? `Dockerfile` ??????????????????????????????????????? `Dockerfile` ????????????????????? `Dockerfile` ???????? Dockerfile??

?????????????????? `Dockerfile` ?????????????????? `Dockerfile`???????????????¶À???????????ßµ?????????? `-f ../Dockerfile.php` ???????????????? `Dockerfile`??

????????????????????????????? `Dockerfile`??????????????????????????ß≥?

### ???? `docker build` ???°¬?

#### ????? Git repo ???ß€???

???????????????`docker build` ?????? URL ????????????????? Git repo ?ß€?????

```bash
$ docker build https://github.com/twang2218/gitlab-ce-zh.git#:8.14
docker build https://github.com/twang2218/gitlab-ce-zh.git\#:8.14
Sending build context to Docker daemon 2.048 kB
Step 1 : FROM gitlab/gitlab-ce:8.14.0-ce.0
8.14.0-ce.0: Pulling from gitlab/gitlab-ce
aed15891ba52: Already exists
773ae8583d14: Already exists
...
```

????????????????????? Git repo????????????? `master` ???????????? `/8.14/`????? Docker ??????? `git clone` ?????????ß›???????????????????????????????

#### ??????? tar ?????????

```bash
$ docker build http://server/context.tar.gz
```

??????????? URL ????? Git repo??????? `tar` ?????????? Docker ???????????????????????????????????????????????????

#### ?????????ßÿ?? Dockerfile ???ß€???

```bash
docker build - < Dockerfile
```

??

```bash
cat Dockerfile | docker build -
```

?????????????????????????????? `Dockerfile`???????????????????????????????????ßÿ?? Dockerfile ????????????????????????????????????????????????????? `COPY` ?????????????Óï

#### ?????????ßÿ????????????????ß€???

```bash
$ docker build - < context.tar.gz
```

?????????????????????? `gzip`??`bzip2` ??? `xz` ????????????????????????????????????????????????????????????????
