---
title: Elastic ??????????????
date: 2017-12-06
categories:
- javatool
tags:
- java
- javatool
- log
- elastic
---

# Elastic ??????????????

## ????

### ELK ????

ELK ?? elastic ????????????? [ElasticSearch](https://www.elastic.co/products/elasticsearch) ??[Logstash](https://www.elastic.co/products/logstash) ??[Kibana](https://www.elastic.co/products/kibana) ???????????

[ElasticSearch](https://www.elastic.co/products/elasticsearch) ????????? [Lucene](http://lucene.apache.org/core/documentation.html) ????????????????RESTful ???????µµ

[Logstash](https://www.elastic.co/products/logstash) ??????????????????????????????

[Kibana](https://www.elastic.co/products/kibana) ?? Elasticsearch ?????????????????????????

### ?????? ELK ??

????????????????????????????????????????????????????????????????????????????????????¦Ë????????????????????????????????????????????????????????????

????? ELK ???????????????????????????????????????????????????

### Elastic ???

<br><div align="center"><img src="https://www.elastic.co/guide/en/logstash/current/static/images/deploy3.png"/></div><br>

> **???**
>
> ?????? ELK ????????????????????§á???????????????????
>
> [Beats](https://www.elastic.co/products/beats) ???????????????????????????????????????????? Logstash ?? ElasticSearch???? Beats ???????????????????????????????????
>
> [Logstash](https://www.elastic.co/products/logstash) ????????????????????????? TCP/UDP/HTTP ?????????????????????? Beats ???????????????????????????????????????¦Ä???
>
> [ElasticSearch](https://www.elastic.co/products/elasticsearch) ????????? JSON ???????????????????µµ??? ELK ???????????§Õ›¥?????
>
> [Kibana](https://www.elastic.co/products/kibana) ?? ELK ????????µµ???????????????§á?????????????????¦Ë???????????????¨¢????? ELK ????µµ

## ???

### ???

ELK ????????§Ñ???? JDK ??????????????????????????????????ï“

```bash
java -version
```

> **???**
>
> ???????? ELK ?? 6.0.0????? jdk ?·Ú?????? JDK8??
>
> ???????????? ELK ???????????????????·Ú??????????§»???????????????»Ç????·Ú????????????????¨¹????????

### Elasticsearch

????????????

1. [elasticsearch ?????????](https://www.elastic.co/downloads/elasticsearch)????????·Ú??????????????
2. ???? `bin/elasticsearch` ??Windows ?????? `bin\elasticsearch.bat`??
3. ??????§Ô????linux ???????? `curl http://localhost:9200/` ??windows ??????¡Â??? REST ???????????? http://localhost:9200/

> **???**
>
> Linux ??????????????????????????????
>
> ```
> curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.0.0.tar.gz
> ```
>
> Mac ?????????????????????§Ñ????
>
> ```
> brew install elasticsearch
> ```
>
> Windows ???????? MSI ????§Ñ???????????????????

### Logstash

????????????

1. ?? [logstash ?????????](https://www.elastic.co/downloads/logstash)????????·Ú??????????????

2. ?????? `logstash.conf` ?????????????????????????????¨¢????????????

   ```
   input { stdin { } }
   output {
     elasticsearch { hosts => ["localhost:9200"] }
     stdout { codec => rubydebug }
   }
   ```

3. ???? `bin/logstash -f logstash.conf` ??Windows ??????`bin/logstash.bat -f logstash.conf`??

### Kibana

????????????

1. ?? [kibana ?????????](https://www.elastic.co/downloads/kibana)????????·Ú??????????????
2. ??? `config/kibana.yml` ????????????? `elasticsearch.url` ??? Elasticsearch ?????
3. ???? `bin/kibana` ??Windows ?????? `bin\kibana.bat`??
4. ???????????? http://localhost:5601

### ??? FAQ

#### elasticsearch ???????? root ?????????

**????**?? Linux ?????§µ?elasticsearch ???????? root ????????§³?

????? root ??????? elasticsearch????????????????

```
can not run elasticsearch as root
```

**?????????**??¡Â? root ?????????? elasticsearch

```bash
# ?????????
groupadd elk
# ???????????-g elk ???????????? elk??-p elk ??????????? elk
useradd elk -g elk -p elk
# ???? /opt ????§Þ????????????????????? elk:elk
chown -R elk:elk /opt # ??????? elasticsearch ????? opt ????
# ?§Ý????
su elk
```

#### vm.max_map_count ?????? 262144

**????**`vm.max_map_count` ???????????§³?????????????????elasticsearch ?????? `vm.max_map_count` ?????? 262144??

```
max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]
```

**?????????**

???????????????????? `vm.max_map_count` ??????????????????????

```
sysctl -w vm.max_map_count=262144
```

?????????????? `/etc/sysctl.conf` ???????? `vm.max_map_count`  ??????

```
echo "vm.max_map_count=262144" > /etc/sysctl.conf
sysctl -p
```

> **???**
>
> ??????§Ý???? docker ?????????????????? sysctl ?????????????
>
> ???????????????????????????????????????

#### nofile ?????? 65536

**????**  `nofile` ???????????????????????elasticsearch ?????????????????????????? 65536??

```
max file descriptors [4096] for elasticsearch process is too low, increase to at least [65536]
```

**?????????**

?? `/etc/security/limits.conf` ???????? `nofile` ??????

```
echo "* soft nofile 65536" > /etc/security/limits.conf
echo "* hard nofile 131072" > /etc/security/limits.conf
```

#### nproc ?????? 2048

**????** `nproc` ?????????????elasticsearch ????????????????? 2048??

```
max number of threads [1024] for user [user] is too low, increase to at least [2048]
```

**?????????**

?? `/etc/security/limits.conf` ???????? `nproc` ??????

```
echo "* soft nproc 2048" > /etc/security/limits.conf
echo "* hard nproc 4096" > /etc/security/limits.conf
```

#### Kibana No Default Index Pattern Warning

**????**??? ELK ????? kibana ?????????????????????

```
Warning No default index pattern. You must select or create one to continue.
...
Unable to fetch mapping. Do you have indices matching the pattern?
```

?????? logstash ??§Ñ????§Õ?? elasticsearch??

**?????????**

??? logstash ?? elasticsearch ????????????????????????????

## ???

???????? Java ???????? slf4j + logback???????????? logback ??????

### Java ??????????? ELK

**??? logstash.conf ????**

?????????????????? logstash ????? logstash.conf ?§Ö?????

```
input { 
  # stdin { }
  tcp { 
    # host:port????????appender?§Ö? destination??
	# ?????????logstash??????????9250??????logback????????? 
    host => "127.0.0.1" port => 9250 mode => "server" tags => ["tags"] codec => json_lines 
  }
}
output {
  elasticsearch { hosts => ["localhost:9200"] }
  stdout { codec => rubydebug }
}
```

> **???**
>
> ??? input ?§Ö?????????? logstash ???????? 9250 ???????????????????????

????? Java ???? pom.xml ?????? jar ????

```xml
<dependency>
  <groupId>net.logstash.logback</groupId>
  <artifactId>logstash-logback-encoder</artifactId>
  <version>4.11</version>
</dependency>
```

??????? logback.xml ????? appender

```xml
<appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
  <!--
  destination ?? logstash ????? host:port??
  ????? logstash ???????????????????????? logstash
  -->
  <destination>127.0.0.1:9250</destination>
  <encoder charset="UTF-8" class="net.logstash.logback.encoder.LogstashEncoder"/>
</appender>
<logger name="io.github.dunwu.spring" level="TRACE" additivity="false">
  <appender-ref ref="LOGSTASH" />
</logger>
```

????????`io.github.dunwu.spring` ???§Ö? TRACE ????????????????????????????? logstash ????

<br><div align="center"><img src="http://upload-images.jianshu.io/upload_images/3101171-cd876d79a14955b0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"/></div><br>

## ????

- [elastic ??????](https://www.elastic.co/guide/index.html)

- [elasticsearch github](https://github.com/elastic/elasticsearch)

- [logstash github](https://github.com/elastic/logstash)

- [kibana github](https://github.com/elastic/kibana)


