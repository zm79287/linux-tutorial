---
title: samba ??????
date: 2018-09-28
categories:
  - linux
tags:
  - linux
  - windows
---

# samba ??????

> samba ???? Linux ?? UNIX ??????? SMB ßø??????????????
>
> samba ????????????????????????????????????????????
>
> ??????`samba`, `selinux`

<!-- TOC depthFrom:2 depthTo:3 -->

- [1. ??????? samba](#1-???????-samba)
    - [1.1. ??????????? samba](#11-???????????-samba)
    - [1.2. ??? samba ????](#12-???-samba-????)
    - [1.3. ???? samba](#13-????-samba)
    - [1.4. ???? samba ???](#14-????-samba-???)
    - [1.5. ???? samba ????](#15-????-samba-????)
    - [1.6. ? samba ???????????](#16-?-samba-???????????)
    - [1.7. ???? samba ????](#17-????-samba-????)
    - [1.8. ???? samba ?????????](#18-????-samba-?????????)
- [2. ???????](#2-???????)
    - [2.1. samba ???????](#21-samba-???????)
    - [2.2. ?????? [global]](#22-??????-global)
    - [2.3. ??????? [??????]](#23-???????-??????)
- [3. ????????](#3-????????)
    - [3.1. ?????????????????????](#31-?????????????????????)
    - [3.2. window ??? samba ?????????](#32-window-???-samba-?????????)
- [4. ?¶œ?????](#4-?¶œ?????)

<!-- /TOC -->

## 1. ??????? samba

?????????????????????????????? samba ????? Linux ?? Windows ?????????

?????????????? Linux ????????? /share/fs ????

### 1.1. ??????????? samba

- CentOS??`rpm -qa | grep samba`
- Ubuntu??`dpkg -l | grep samba`

### 1.2. ??? samba ????

- CentOS??`yum install -y samba samba-client samba-common`
- Ubuntu??`sudo apt-get install -y samba samba-client`

### 1.3. ???? samba

samba ?????????????? `/etc/samba/smb.conf`?????????? samba ?????????

??????????????????????

```bash
vim /etc/samba/smb.conf
```

????????????

```ini
[global]
        workgroup = SAMBA
        security = user

        passdb backend = tdbsam

        printing = cups
        printcap name = cups
        load printers = yes
        cups options = raw

[homes]
        comment = Home Directories
        valid users = %S, %D%w%S
        browseable = No
        read only = No
        inherit acls = Yes

[printers]
        comment = All Printers
        path = /var/tmp
        printable = Yes
        create mask = 0600
        browseable = No

[print$]
        comment = Printer Drivers
        path = /var/lib/samba/drivers
        write list = @printadmin root
        force group = @printadmin
        create mask = 0664
        directory mask = 0775

[fs]
        comment = share folder
        path = /share/fs
        browseable = yes
        writable = yes
        read only = no
        guest ok = yes
        create mask = 0777
        directory mask = 0777
        public = yes
        valid users = root
```

> ?????
>
> - ???????????????? **[fs]** ?????????????????????®¢?
> - ???????? `path` ????? `/share/fs`????¶∆????????? `/share/fs` ?????????????????????°§????`/share/fs` ????????????? **777**??`chmod 777 /share/fs`??
> - `browseable`??`writable` ????????????????????????®¥??????????????
> - `valid users` ??????????????????????????????????????????? Linux ??????????????????

### 1.4. ???? samba ???

?????? samba ????????? Linux ??????????????????

```bash
$ sudo smbpasswd -a root
New SMB password:
Retype new SMB password:
Added user root.
```

??????????? samba ??????????? samba ???????????????????? Windows ?????????????????????????????????????????????

- ?? samba ???????????????ßª??? - `pdbedit -L`
- ??? samba ?????ß÷??????? - `smbpasswd -x ?????`

### 1.5. ???? samba ????

CentOS 6

```bash
$ sudo service samba restart  # ???? samba
$ sudo service smb restart    # ???? samba
```

CentOS 7

```bash
$ sudo systemctl start smb.service     # ???? samba
$ sudo systemctl restart smb.service   # ???? samba
$ sudo systemctl enable smb.service    # ??????????????
$ sudo systemctl status smb.service    # ??? samba ??
```

Ubuntu 16.04.3

```
$ sudo service smbd restart
```

### 1.6. ? samba ???????????

```
$ sudo firewall-cmd --permanent --zone=public --add-service=samba
$ sudo firewall-cmd --reload
```

### 1.7. ???? samba ????

```
$ smbclient //localhost/fs -U root
```

???? samba ??????????????????????? `smb: \>`??

### 1.8. ???? samba ?????????

Windows??

?????`\\<???ip>\<??????°§??>` ??

<br><div align="center"><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20180920180928161334.png"/></div><br>

Mac??

?? Windows ?????????? Finder ?ßŸ??? `smb://<???ip>/<??????°§??>` ???®¿?

## 2. ???????

### 2.1. samba ???????

?????? [????](https://git.samba.org/samba.git/?p=samba.git;a=blob_plain;f=examples/smb.conf.default;hb=HEAD) ?????????????????

```
$ cp /etc/samba/smb.conf /etc/samba/smb.conf.bak
$ wget "https://git.samba.org/samba.git/?p=samba.git;a=blob_plain;f=examples/smb.conf.default;hb=HEAD" -O /etc/samba/smb.conf
```

smb.conf ????????????

```ini
[global]
        workgroup = SAMBA
        security = user

        passdb backend = tdbsam

        printing = cups
        printcap name = cups
        load printers = yes
        cups options = raw

[homes]
        comment = Home Directories
        valid users = %S, %D%w%S
        browseable = No
        read only = No
        inherit acls = Yes

[printers]
        comment = All Printers
        path = /var/tmp
        printable = Yes
        create mask = 0600
        browseable = No

[print$]
        comment = Printer Drivers
        path = /var/lib/samba/drivers
        write list = root
        create mask = 0664
        directory mask = 0775
```

### 2.2. ?????? [global]

```ini
[global]

config file = /usr/local/samba/lib/smb.conf.%m
?????config file???????????????????????????????????????????????? ??????????????ßπ???????????????????????samba????????????????samba?????????????????????????????Ì‡??????PC1??????????????????????Samba Server???????????????????????????/etc/samba/host/???PC1??????????smb.conf.pc1????????????smb.conf?ßﬁ???config file=/etc/samba/host/smb.conf.%m????????PC1????????Samba Server???smb.conf.%m????ùI??smb.conf.pc1????????????PC1?????????????Samba?????????smb.conf.pc1????????????????????Samba Server???????smb.conf??

workgroup = WORKGROUP
??????⁄Ö Samba Server ??????????????????

server string = Samba Server Version %v
??????⁄Ö Samba Server ?????????????¶ ???????????????˛ü??%v??????Samba??∑⁄???

netbios name = smbserver
?????????Samba Server??NetBIOS?????????????????????°¬???????DNS????????????netbios name??workgroup?????????®Æ???????

interfaces = lo eth0 192.168.12.2/24 192.168.13.2/24
?????????Samba Server??????ßª??????????ß’?????????????ß’????????IP?????

hosts allow = 127.192.168.1 192.168.10.1
?????????????????Samba Server????????????????????????????????IP??????????????????¶¡????hosts deny ??hosts allow ???????
???ª«
# ???????????172.17.2.*.*????????????????172.17.2.50
hosts allow=172.17.2.EXCEPT172.17.2.50
# ???????????172.17.2.0/255.255.0.0?????ß÷?????????????
hosts allow=172.17.2.0/255.255.0.0
# ???????????M1??M2????????????
hosts allow=M1??M2
# ???????????SC??????ßﬁ????????
hosts allow=@SC
max connections = 0
?????max connections???????????Samba Server?????????????????????????????????????????????????0??????????

deadtime = 0
?????deadtime???????????????ß’??¶ ????????????????¶À??????0????Samba Server??????ßÿ??¶ ??????

time server = yes/no
?????time server??????????nmdb???windows????????????????

log file = /var/log/samba/log.%m
?????????Samba Server????????õ•¶À?????????????????????????????%m???????????????????????Samba Server????????????????????????????pc1??pc2?????Samba Server???????/var/log/samba????????log.pc1??log.pc2????????????

max log size = 50
?????????Samba Server???????????????????¶À?kB??0?????????

security = user
????????????????Samba Server???????????????????????????
1. share?????????Samba Server?????????????????, ??????????
2. user??Samba Server??????????????????????,??Samba Server?????????????????????????????????Samba Server?ßﬂ?????
3. server??????????Windows NT/2000??Samba Server??????????????????,???????????????????????,???????????????ß÷?Windows?????????ß÷????NT????,???Windows NT????Samba???, ?????????????????????????????,?????????,Samba???????????????????????????
4. domain?????????,????????????(PDC)??????????

passdb backend = tdbsam
?????passdb backend?????????????????????????????smbpasswd??tdbsam??ldapsam??sam?????security account manager???????????????ß’??

smbpasswd???°¬???????smb????????smbpasswd??????????????
???????????????????????Samba?????????????????????????Samba???????
1. smbpasswd????????/etc/samba?????????????????????????????
2. tdbsam???°¬????????????????????????????????????????????passdb.tdb???????/etc/samba?????passdb.tdb??????????????smbpasswd ?Ca??????Samba????????????????Samba??????????????????????????????pdbedit??????????Samba?????pdbedit????????????????ß‘???????????
  pdbedit ?Ca username?????Samba?????
  pdbedit ?Cx username?????Samba?????
  pdbedit ?CL???ß‘?Samba????ß“????passdb.tdb??????????
  pdbedit ?CLv???ß‘?Samba????ß“??????????
  pdbedit ?Cc ??[D]?? ?Cu username???????Samba?????????
  pdbedit ?Cc ??[]?? ?Cu username???????Samba?????????
3. ldapsam???°¬?????????LDAP?????????????????????????????LDAP??????????®¢?passdb backend = ldapsam:ldap://LDAP Server??

encrypt passwords = yes/no
??????????????????????????windows????????????®π??????????????????????˛ü?????????????????????

smb passwd file = /etc/samba/smbpasswd
?????????????samba??????????????smbpasswd?????????????????????

username map = /etc/samba/smbusers
?????????????????????????????root????administrator??admin??????????????smbusers????ßÿ???®¢????ª«root = administrator admin?????????????administrator??admin???????????????root???Samba Server????????windows?????????

guest account = nobody
?????????????guest???????

socket options = TCP_NODELAY SO_RCVBUF=8192 SO_SNDBUF=8192
????????????°¬?????????????????Socket??????????????????

domain master = yes/no
?????????Samba???????????????????????????????????????????????????????????

local master = yes/no
?????local master???????Samba Server????????????????????????????????no?????????????????????????????????????????yes??????????Samba Server?????????????????????¶Ã?????

preferred master = yes/no
?????????Samba Server???????????????????????????????Samba Server???????????????????????????®∞???????yes???????domain master?????yes?????®∞??????????????Samba Server????????????????????????????windows NT????????Samba Server?????????????????????????ßª??????????????????????????????????????????????????????????????ßÿ??Samba Server?????????????????⁄Ö???????®¿?

os level = 200
?????????samba????????os level???®∞???????Samba Server????ß›???????????????????????os level??0??255??winNT??os level??32??win95/98??os level??1??Windows 2000??os level??64??????????0??????¶∆??Samba Server?????????????????Samba Server???PDC???????????os level????ßª??

domain logons = yes/no
?????????Samba Server?????????????????????????????????????????????????????˛ü

logon . = %u.bat
??????????????windows????????????Samba????????????????????®Æ?%u.bat?????????????????????????????????????????˙ë?????????®Æ????????????????????start.bat??????????????????start.bat????????????????⁄Ö????????????????????????[netlogon]??path???????°§?????

wins support = yes/no
?????????samba???????????wins????

wins server = wins??????IP???
?????????Samba Server????????wins????????wins????

wins proxy = yes/no
?????????Samba Server?????wins???????

dns proxy = yes/no
?????????Samba Server?????dns???????

load printers = yes/no
??????????????????Samba????????????

printcap name = cups
????????®¥??????????????????

printing = cups
?????????Samba????????????????????????????ßµ?bsd, sysv, plp, lprng, aix, hpux, qnx
```

### 2.3. ??????? [??????]

```ini
[??????]

comment = ?????????
?????comment???®¥???????????????????????????

path = ??????°§??
?????path???????????????°§??????????%u??%m?????????????°§?????unix???????????Netbios?????®≤??????????[homes]?????????ª«??????????????home???????????????????/home/share/??????Linux????????????????????????????????????????path?????ß’???path = /home/share/%u; ??????????????????????°§????????????????ó®????????????°§????????????????????????????????????°§??????????????????????????????????????????????????????????????????????samba????????????????????netbios????°§?????????????????????????????????ß’??path = /home/share/%m ??

browseable = yes/no
?????browseable????????®¥??????????????

writable = yes/no
?????writable????????®¥???°§??????ß’??

available = yes/no
?????available????????®¥???????????®¢?

admin users = ?®¥?????????
?????admin users????????®¥????????????®¥?????????????????????samba 3.0?ßµ????????????????®Æ®¿?security=share???????????ßπ??
???ª«admin users =bobyuan??jane?????????ßﬁ?????????????

valid users = ???????®¥???????
?????valid users??????????????®¥?????????????
???ª«valid users = bobyuan??@bob??@tech???????????????ßﬁ??????????????????????????®¢?@+?????????????

invalid users = ???????®¥???????
?????invalid users????????????????®¥?????????????
???ª«invalid users = root??@bob???????????????ßﬁ?????????????

write list = ????ß’??®¥???????
?????write list?????????????®¥?????ß’????????????
???ª«write list = bobyuan??@bob

public = yes/no
?????public????????®¥??????????guest????????

guest ok = yes/no
????????????public????

??????????
[homes]
comment = Home Directories
browseable = no
writable = yes
valid users = %S
; valid users = MYDOMAIN\%S

[printers]
comment = All Printers
path = /var/spool/samba
browseable = no
guest ok = no
writable = no
printable = yes

[netlogon]
comment = Network Logon Service
path = /var/lib/samba/netlogon
guest ok = yes
writable = no
share modes = no

[Profiles]
path = /var/lib/samba/profiles
browseable = no
guest ok = yes
```

## 3. ????????

### 3.1. ?????????????????????

????????

- ???? **NT_STATUS_ACCESS_DENIED** ????
- Windows ??????? samba ???????????????????????????????????????????

??????—s

1. ????????????????????

```bash
# ??????????ß€??????
$ sudo service iptables stop

# ?????????????°¬????????
$ sudo firewall-cmd --permanent --zone=public --add-service=samba
$ sudo firewall-cmd --reload
```

2. ??? selinux

```bash
# ?? /etc/selinux/config ????ß÷? SELINUX ??? disabled
$ sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config

# ??????ßπ
$ reboot
```

### 3.2. window ??? samba ?????????

1. windows ??????? samba ????????????
   - ?? dos ?????????? `control userpasswords2` ???? `control keymgr.dll`?????????/???????????????????????????
2. windows ???????? linux ?? samba ?????
   1. ?? win ???????ß≥?
   2. ???? net use????????????????????????ß“?
   3. ?????ß“?????????????? net use ??????????? /del???????????????????`net use * /del`??

## 4. ?¶œ?????

- http://blog.51cto.com/yuanbin/115761
- https://www.jianshu.com/p/750be209a6f0
- https://github.com/judasn/Linux-Tutorial/blob/master/markdown-file/Samba.md
- https://blog.csdn.net/lan120576664/article/details/50396511
